<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Riser 3D Displacement Monitoring</title>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  label { margin-right: 15px; }
  table { border-collapse: collapse; margin-top: 10px; width: 100%; }
  th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
  th { background: #f2f2f2; }
</style>
</head>

<body>

<h2>Riser 3D Displacement Monitoring</h2>

<input type="file" id="fileInput" accept=".xlsx">

<div style="margin-top:10px;">
  <label>
    <input type="checkbox" checked onchange="toggleCapacity(this.checked)">
    Show Capacity Color
  </label>

  <label>
    <input type="checkbox" checked onchange="toggleTable(this.checked)">
    Show Data Table
  </label>
</div>

<div id="conditionControls" style="margin-top:10px;"></div>

<div id="plot" style="width:100%;height:700px;"></div>

<div id="tableContainer"></div>

<script>
let rows = [];
let traces = [];
let conditionMap = {};
let showCapacity = true;

document.getElementById("fileInput").addEventListener("change", e => {
  const reader = new FileReader();
  reader.onload = evt => {
    const workbook = XLSX.read(new Uint8Array(evt.target.result), { type: "array" });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    rows = XLSX.utils.sheet_to_json(sheet);
    buildPlot();
    buildTable();
  };
  reader.readAsArrayBuffer(e.target.files[0]);
});

function buildPlot() {
  traces = [];
  conditionMap = {};
  document.getElementById("conditionControls").innerHTML = "";

  const conditions = [...new Set(rows.map(r => r.Condition))];

  conditions.forEach((cond, i) => {
    const data = rows.filter(r => r.Condition === cond); // KHÔNG SORT

    const x = data.map(r => r.x);
    const y = data.map(r => r.y);
    const z = data.map(r => r.z);
    const cap = data.map(r => r.Capacity);

    const baseIndex = traces.length;

    // Trace chính
    traces.push({
      name: cond,
      x, y, z,
      mode: "lines+markers",
      type: "scatter3d",
      text: data.map(r =>
        `Date: ${r.Date}<br>Capacity: ${r.Capacity}%`
      ),
      marker: {
        size: 6,
        color: showCapacity ? cap : "gray",
        colorscale: "Jet",
        colorbar: showCapacity && i === 0 ? { title: "Capacity (%)" } : undefined
      }
    });

    // Start – record đầu tiên
    traces.push({
      name: cond + " (Start)",
      x: [x[0]], y: [y[0]], z: [z[0]],
      mode: "markers",
      type: "scatter3d",
      marker: { size: 9, color: "green" }
    });

    // End – record cuối cùng
    traces.push({
      name: cond + " (End)",
      x: [x[x.length - 1]],
      y: [y[y.length - 1]],
      z: [z[z.length - 1]],
      mode: "markers",
      type: "scatter3d",
      marker: { size: 9, color: "red" }
    });

    conditionMap[cond] = baseIndex;

    document.getElementById("conditionControls").innerHTML +=
      `<label>
        <input type="checkbox" checked
          onchange="toggleCondition('${cond}', this.checked)">
        ${cond}
      </label>`;
  });

  Plotly.newPlot("plot", traces, {
    title: "Riser Movement 3D",
    scene: {
      xaxis: { title: "N – S" },
      yaxis: { title: "W – E" },
      zaxis: { title: "Vertical" }
    }
  });
}

function toggleCondition(cond, visible) {
  const i = conditionMap[cond];
  Plotly.restyle("plot",
    { visible: visible ? true : "legendonly" },
    [i, i + 1, i + 2]
  );
}

function toggleCapacity(enable) {
  showCapacity = enable;
  traces.forEach((t, i) => {
    if (t.mode === "lines+markers") {
      Plotly.restyle("plot", {
        "marker.color": enable ? [t.marker.color] : ["gray"],
        "marker.colorbar": enable ? t.marker.colorbar : null
      }, i);
    }
  });
}

function buildTable() {
  let html = `<table>
    <tr>
      <th>Date</th>
      <th>Condition</th>
      <th>x</th><th>y</th><th>z</th>
      <th>Capacity</th>
    </tr>`;

  rows.forEach(r => {
    html += `<tr>
      <td>${r.Date}</td>
      <td>${r.Condition}</td>
      <td>${r.x}</td>
      <td>${r.y}</td>
      <td>${r.z}</td>
      <td>${r.Capacity}</td>
    </tr>`;
  });

  html += "</table>";
  document.getElementById("tableContainer").innerHTML = html;
}

function toggleTable(show) {
  document.getElementById("tableContainer").style.display = show ? "block" : "none";
}
</script>

</body>
</html>
