<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>3D Riser Movement Tracking</title>

<script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body { font-family: Arial; margin: 15px; }
.container { display: flex; gap: 15px; }
#plot { width: 70%; height: 650px; }
#panel { width: 30%; }

table {
  border-collapse: collapse;
  width: 100%;
  font-size: 13px;
}
th, td {
  border: 1px solid #ccc;
  padding: 6px;
  text-align: center;
}
th { background: #f2f2f2; }
</style>
</head>

<body>

<h2>3D Riser Movement Tracking</h2>
<input type="file" id="fileInput" accept=".xlsx,.xls">

<div class="container">
  <div id="plot"></div>

  <div id="panel">
    <h3>Condition Control</h3>
    <table id="conditionTable">
      <thead>
        <tr>
          <th>Show</th>
          <th>Condition</th>
          <th>Date</th>
          <th>Capacity</th>
          <th>Color</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
let rawData = [];
let conditions = [];
let visible = {};

document.getElementById("fileInput").addEventListener("change", loadFile);

function loadFile(e) {
  const reader = new FileReader();
  reader.onload = evt => {
    const wb = XLSX.read(evt.target.result, { type: "binary" });
    const sheet = wb.Sheets[wb.SheetNames[0]];

    // Giữ nguyên Date dạng TEXT
    rawData = XLSX.utils.sheet_to_json(sheet, {
      raw: false,
      defval: ""
    });

    extractConditions();
    buildTable();
    drawPlot();
  };
  reader.readAsBinaryString(e.target.files[0]);
}

function extractConditions() {
  conditions = [];
  rawData.forEach(r => {
    if (!conditions.includes(r.Condition)) {
      conditions.push(r.Condition);
    }
  });
  conditions.forEach(c => visible[c] = true);
}

function getColor(cond) {
  if (cond === conditions[0]) return "yellow";          // condition đầu
  if (cond === conditions[conditions.length - 1]) return "red"; // condition cuối
  return "green";
}

function getEndPoint(cond) {
  const rows = rawData.filter(r => r.Condition === cond);
  return rows[rows.length - 1];
}

function buildTable() {
  const tb = document.querySelector("#conditionTable tbody");
  tb.innerHTML = "";

  conditions.forEach(cond => {
    const rows = rawData.filter(r => r.Condition === cond);
    const startDate = rows[0].Date;
    const endCapacity = Math.round(rows[rows.length - 1].Capacity);

    const tr = document.createElement("tr");

    const chk = document.createElement("input");
    chk.type = "checkbox";
    chk.checked = true;
    chk.onchange = () => {
      visible[cond] = chk.checked;
      drawPlot();
    };

    tr.innerHTML = `
      <td></td>
      <td>${cond}</td>
      <td>${startDate}</td>
      <td>${endCapacity}</td>
      <td style="color:${getColor(cond)}">${getColor(cond)}</td>
    `;
    tr.children[0].appendChild(chk);
    tb.appendChild(tr);
  });
}

function drawPlot() {
  const traces = [];

  // ===== ĐƯỜNG 3D THEO TỪNG CONDITION =====
  conditions.forEach(cond => {
    if (!visible[cond]) return;

    const d = rawData.filter(r => r.Condition === cond);

    traces.push({
      type: "scatter3d",
      mode: "lines+markers",
      name: cond,

      x: d.map(r => r.x),
      y: d.map(r => r.y),
      z: d.map(r => r.z),

      marker: { size: 4, color: getColor(cond) },
      line: { width: 3, color: getColor(cond) },

      text: d.map(r =>
        `Condition: ${cond}<br>` +
        `Date: ${r.Date}<br>` +
        `X (N-S): ${Math.round(r.x)}<br>` +
        `Y (W-E): ${Math.round(r.y)}<br>` +
        `Z (V riser): ${Math.round(r.z)}<br>` +
        `Capacity: ${Math.round(r.Capacity)}`
      ),
      hovertemplate: "%{text}<extra></extra>"
    });
  });

  // ===== ĐOẠN THẲNG NỐI GIỮA CÁC CONDITION (DỊCH CHUYỂN) =====
  for (let i = 0; i < conditions.length - 1; i++) {
    const c1 = conditions[i];
    const c2 = conditions[i + 1];

    if (!visible[c1] || !visible[c2]) continue;

    const p1 = getEndPoint(c1);
    const p2 = getEndPoint(c2);

    traces.push({
      type: "scatter3d",
      mode: "lines",

      x: [p1.x, p2.x],
      y: [p1.y, p2.y],
      z: [p1.z, p2.z],

      line: {
        color: "gray",
        width: 4,
        dash: "dash"
      },

      name: `${c1} → ${c2}`,
      hoverinfo: "skip"
    });
  }

  Plotly.newPlot("plot", traces, {
    scene: {
      xaxis: { title: "N-S" },
      yaxis: { title: "W-E" },
      zaxis: { title: "V riser" }
    },
    margin: { l: 0, r: 0, t: 0, b: 0 }
  });
}
</script>

</body>
</html>
